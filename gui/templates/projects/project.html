{% extends "main/base.html" %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'projects/project.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'tasks/task.css' %}">
    <div class="project-container">
        <div class="col-12">
            <h1 class="project-title">
                {{ project.name }}
                <i type="button" class="fas fa-trash-alt project-delete-icon" id="project-delete-icon"></i>
            </h1>
            <a href="/tasks/{{ project.id }}/create" class="fas fa-plus add-icon"></a>
        </div>
        <div class="tasks-table">
            <div class="column">
                <div class="table-header">OPEN</div>
                <div class="sub-column" id="column-open">
                    {% for task in open_tasks %}
                        {% include "tasks/task.html" with id=task.id title=task.title type=task.type.type status=task.status.status assignee=task.assignee %}
                    {% endfor %}
                </div>
            </div>

            <div class="column">
                <div class="table-header">IN PROGRESS</div>
                <div class="sub-column" id="column-in-progress">
                    {% for task in in_progress_tasks %}
                        {% include "tasks/task.html" with id=task.id title=task.title type=task.type.type status=task.status.status assignee=task.assignee %}
                    {% endfor %}
                </div>
            </div>

            <div class="column">
                <div class="table-header">DONE</div>
                <div class="sub-column" id="column-done">
                    {% for task in done_tasks %}
                        {% include "tasks/task.html" with id=task.id title=task.title type=task.type.type status=task.status.status assignee=task.assignee %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script>
        {% for task in tasks %}
            setupTask({{ task.id }});
        {% endfor %}

        var socketSingle = new WebSocket('ws://127.0.0.1:8000/ws/{{ project.id }}');
        const onMessageCallbacks = {
            'task_create': handleCreate,
            'task_update': handleUpdate,
            'task_delete': handleDelete,
        };

        socketSingle.onmessage = function (e) {
            console.log('Received message:', e.data);
            if (e.data === 'connected') {
                return;
            }
            const event = JSON.parse(e.data);
            const type = event.type;
            onMessageCallbacks[type](event.task);
        };

        document.getElementById('project-delete-icon')?.addEventListener('click', function () {
            fetch('http://localhost:8000/api/projects/{{ project.id }}', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(() => window.location.href = '/projects')
                .then(() => console.log(`Project {{ project.id }} deleted`))
                .catch(err => alert(err));
        });

        function handleCreate(task) {
            fetch(`http://localhost:8000/tasks/${task.id}/card`)
                .then(response => response.text())
                .then(data => {
                    const taskDiv = document.createElement('div');
                    taskDiv.innerHTML = data;
                    const column = document.getElementById(`column-${justifyStatus(task.status)}`);
                    column.appendChild(taskDiv.querySelector('.task'));
                    setupTask(task.id);
                });
        }

        function handleUpdate(task) {
            const taskDiv = document.getElementById(`task-${task.id}`);
            const taskIdField = taskDiv?.querySelector('.task-id');
            const taskTitleField = taskDiv?.querySelector('.task-title');
            const taskTypeField = taskDiv?.querySelector('.task-type');
            const taskStatusField = taskDiv?.querySelector('.task-status');
            const taskAssigneeField = taskDiv?.querySelector('.task-assignee');

            taskTitleField.innerHTML = task.title;
            taskTypeField.innerHTML = task.type;
            taskStatusField.innerHTML = `Status: ${task.status}`;
            taskAssigneeField.innerHTML = `Assignee: ${task.assignee}`;

            const taskHeader = taskDiv.querySelector('.task-header');
            taskHeader.classList.remove('STORY', 'BUG', 'RESEARCH');
            taskHeader.classList.add(task.type);

            const column = document.getElementById(`column-${justifyStatus(task.status)}`);
            column.appendChild(taskDiv);
        }

        function handleDelete(task) {
            const taskDiv = document.getElementById(`task-${task.id}`);
            taskDiv?.remove();
        }

        function justifyStatus(status) {
            return status.toLowerCase().replace(' ', '-');
        }

        function setupTask(id) {
            const taskDiv = document.getElementById(`task-${id}`);
            const taskBody = document.getElementById(`task-body-${id}`);

            taskBody.addEventListener('click', function () {
                window.location.href = `/tasks/${id}`;
            });

            const statusP = document.getElementById(`${id}-status`);

            let columnOpen = document.getElementById('column-open');
            let columnInProgress = document.getElementById('column-in-progress');
            let columnDone = document.getElementById('column-done');

            const leftArrow = document.getElementById(`left-arrow-${id}`);
            const rightArrow = document.getElementById(`right-arrow-${id}`);

            leftArrow.addEventListener('click', function () {
                const currStatus = statusP.innerText.split(' ')[1];
                const newStatus = currStatus === 'DONE' ? 'IN PROGRESS' : 'OPEN';
                updateStatus(newStatus);
            });
            rightArrow.addEventListener('click', function () {
                const currStatus = statusP.innerText.split(' ')[1];
                const newStatus = currStatus === 'OPEN' ? 'IN PROGRESS' : 'DONE';
                updateStatus(newStatus);
            });

            const deleteIcon = document.getElementById(`delete-${id}`);
            deleteIcon.addEventListener('click', function () {
                fetch(`http://localhost:8000/api/tasks/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(() => taskDiv.remove())
                    .then(() => console.log(`Task ${id} deleted`))
                    .catch(err => console.log(err));
            });

            function updateStatus(newStatus) {
                fetch(`http://localhost:8000/api/tasks/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                }).then(() => {
                    console.log(`Status of task ${id} updated to ${newStatus}`);
                })
                    .then(() => {
                        const statusP = document.getElementById(`${id}-status`);
                        statusP.innerText = `Status: ${newStatus}`;
                        moveTask(newStatus);
                    })
                    .catch(err => console.log(err));
            }

            function moveTask(newStatus) {
                columnOpen = columnOpen || document.getElementById('column-open');
                columnInProgress = columnInProgress || document.getElementById('column-in-progress');
                columnDone = columnDone || document.getElementById('column-done');
                switch (newStatus) {
                    case 'OPEN':
                        columnOpen.appendChild(taskDiv);
                        break;
                    case 'IN PROGRESS':
                        columnInProgress.appendChild(taskDiv);
                        break;
                    case 'DONE':
                        columnDone.appendChild(taskDiv);
                        break;
                }
            }
        }
    </script>
{% endblock %}
```